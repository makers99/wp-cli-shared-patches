From 67c94eeebe82e0fb76c2509e1879e7e46534c490 Mon Sep 17 00:00:00 2001
From: Andres A <andres@netzstrategen.com>
Date: Thu, 13 Jan 2022 17:22:08 +0100
Subject: [PATCH] Fixed merchant reference ID does not match the order number.

---
 includes/class-wc-amazon-payments-advanced-api.php          | 6 +++---
 ...ss-wc-gateway-amazon-payments-advanced-subscriptions.php | 2 +-
 includes/class-wc-gateway-amazon-payments-advanced.php      | 4 ++--
 3 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/includes/class-wc-amazon-payments-advanced-api.php b/includes/class-wc-amazon-payments-advanced-api.php
index 6d866c6..7dec8b3 100644
--- a/includes/class-wc-amazon-payments-advanced-api.php
+++ b/includes/class-wc-amazon-payments-advanced-api.php
@@ -758,15 +758,15 @@ public static function cancel_charge( $charge_id, $reason = 'Order Cancelled' )
 	/**
 	 * Get Merchant Metadata object
 	 *
-	 * @param  int $order_id Order ID.
+	 * @param  WC_Order $order Order object.
 	 * @return array
 	 */
-	public static function get_merchant_metadata( $order_id ) {
+	public static function get_merchant_metadata( $order ) {
 		/* translators: Plugin version */
 		$version_note = sprintf( __( 'Created by WC_Gateway_Amazon_Pay/%1$s (Platform=WooCommerce/%2$s)', 'woocommerce-gateway-amazon-payments-advanced' ), WC_AMAZON_PAY_VERSION, WC()->version );
 
 		return array(
-			'merchantReferenceId' => $order_id,
+			'merchantReferenceId' => $order->get_order_number(),
 			'merchantStoreName'   => WC_Amazon_Payments_Advanced::get_site_name(),
 			'customInformation'   => $version_note,
 		);
diff --git a/includes/class-wc-gateway-amazon-payments-advanced-subscriptions.php b/includes/class-wc-gateway-amazon-payments-advanced-subscriptions.php
index 75f4922..361b7ff 100644
--- a/includes/class-wc-gateway-amazon-payments-advanced-subscriptions.php
+++ b/includes/class-wc-gateway-amazon-payments-advanced-subscriptions.php
@@ -540,7 +540,7 @@ public function scheduled_subscription_payment( $amount_to_charge, $order ) {
 		$response = WC_Amazon_Payments_Advanced_API::create_charge(
 			$charge_permission_id,
 			array(
-				'merchantMetadata'              => WC_Amazon_Payments_Advanced_API::get_merchant_metadata( $order_id ),
+				'merchantMetadata'              => WC_Amazon_Payments_Advanced_API::get_merchant_metadata( $order ),
 				'captureNow'                    => $capture_now,
 				'canHandlePendingAuthorization' => $can_do_async,
 				'chargeAmount'                  => array(
diff --git a/includes/class-wc-gateway-amazon-payments-advanced.php b/includes/class-wc-gateway-amazon-payments-advanced.php
index be0db51..18a6131 100644
--- a/includes/class-wc-gateway-amazon-payments-advanced.php
+++ b/includes/class-wc-gateway-amazon-payments-advanced.php
@@ -1207,7 +1207,7 @@ public function process_payment( $order_id ) {
 						'currencyCode' => $currency,
 					),
 				),
-				'merchantMetadata' => WC_Amazon_Payments_Advanced_API::get_merchant_metadata( $order_id ),
+				'merchantMetadata' => WC_Amazon_Payments_Advanced_API::get_merchant_metadata( $order ),
 			);
 
 			$payload = apply_filters( 'woocommerce_amazon_pa_update_checkout_session_payload', $payload, $checkout_session_id, $order );
@@ -2131,7 +2131,7 @@ public function perform_authorization( $order, $capture_now = true, $id = null )
 		$charge = WC_Amazon_Payments_Advanced_API::create_charge(
 			$id,
 			array(
-				'merchantMetadata'              => WC_Amazon_Payments_Advanced_API::get_merchant_metadata( $order_id ),
+				'merchantMetadata'              => WC_Amazon_Payments_Advanced_API::get_merchant_metadata( $order ),
 				'captureNow'                    => $capture_now,
 				'canHandlePendingAuthorization' => $can_do_async,
 				'chargeAmount'                  => array(
